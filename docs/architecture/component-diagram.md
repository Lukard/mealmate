# Meal Automation System - Component Diagrams

## Overview

This document provides detailed component diagrams showing the relationships, dependencies, and data flows between system components using C4 model notation.

---

## C4 Context Diagram (Level 1)

```
+------------------------------------------------------------------+
|                         SYSTEM CONTEXT                            |
+------------------------------------------------------------------+

                                   +----------------+
                                   |    End User    |
                                   |   (Consumer)   |
                                   +-------+--------+
                                           |
              +----------------------------+----------------------------+
              |                            |                            |
              v                            v                            v
     +----------------+          +----------------+          +----------------+
     |   Web Browser  |          |Mobile Browser  |          |Browser Extension|
     |   (Desktop)    |          |   (PWA)        |          | (Chrome/Firefox)|
     +-------+--------+          +-------+--------+          +-------+--------+
             |                           |                           |
             +---------------------------+---------------------------+
                                         |
                                         v
                              +----------------------+
                              |                      |
                              |   Meal Automation    |
                              |       System         |
                              |                      |
                              +----------+-----------+
                                         |
         +-------------------------------+-------------------------------+
         |                               |                               |
         v                               v                               v
+----------------+              +----------------+              +----------------+
|   Supermarket  |              |   Recipe API   |              |    Payment     |
|   Websites     |              |  (Spoonacular) |              |   Gateway      |
| Mercadona,     |              |                |              |   (Stripe)     |
| Carrefour...   |              +----------------+              +----------------+
+----------------+
```

---

## C4 Container Diagram (Level 2)

```
+-----------------------------------------------------------------------------------+
|                              MEAL AUTOMATION SYSTEM                                |
+-----------------------------------------------------------------------------------+

+-------------+     +-------------+     +-------------+     +-------------+
|   Next.js   |     |  Browser    |     |   Mobile    |     |   Admin     |
|   Web App   |     |  Extension  |     |    PWA      |     |  Dashboard  |
|  (React)    |     |  (Plasmo)   |     | (Next.js)   |     |  (Next.js)  |
+------+------+     +------+------+     +------+------+     +------+------+
       |                   |                   |                   |
       +-------------------+-------------------+-------------------+
                                    |
                                    v
                    +-------------------------------+
                    |         API Gateway           |
                    |      (Hono on Vercel Edge)    |
                    |  +-------------------------+  |
                    |  | Auth | Rate  | Logging |  |
                    |  | MW   | Limit | Tracer  |  |
                    |  +-------------------------+  |
                    +---------------+---------------+
                                    |
        +---------------------------+---------------------------+
        |           |           |           |           |       |
        v           v           v           v           v       v
+----------+ +----------+ +----------+ +----------+ +----------+ +----------+
|  Auth    | |  Meal    | | Product  | | Grocery  | | Matching | | Scraper  |
| Service  | | Planning | | Service  | |  List    | |  Engine  | |  Worker  |
|          | | Service  | |          | | Service  | |          | |          |
+----+-----+ +----+-----+ +----+-----+ +----+-----+ +----+-----+ +----+-----+
     |            |            |            |            |            |
     +------------+------------+------------+------------+------------+
                                    |
                    +---------------+---------------+
                    |               |               |
                    v               v               v
            +------------+  +------------+  +------------+
            | PostgreSQL |  |   Redis    |  |   Blob     |
            |   (Neon)   |  |  (Upstash) |  |  Storage   |
            +------------+  +------------+  +------------+

External Services:
+------------------+  +------------------+  +------------------+
|   Supermarket    |  |   Recipe APIs    |  |   Proxy Pool     |
|   Websites       |  |   (Spoonacular)  |  |   (BrightData)   |
+------------------+  +------------------+  +------------------+
```

---

## C4 Component Diagram (Level 3) - Core Services

### Auth Service Components

```
+------------------------------------------------------------------+
|                        AUTH SERVICE                               |
+------------------------------------------------------------------+

+------------------+     +------------------+     +------------------+
|   Registration   |     |     Login        |     |   OAuth2         |
|    Controller    |     |   Controller     |     |   Controller     |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         +------------------------+------------------------+
                                  |
                                  v
                    +---------------------------+
                    |    Authentication         |
                    |       Manager             |
                    +-------------+-------------+
                                  |
         +------------------------+------------------------+
         |                        |                        |
         v                        v                        v
+------------------+     +------------------+     +------------------+
|   Password       |     |   JWT Token      |     |   Session        |
|   Hasher         |     |   Service        |     |   Store          |
|   (bcrypt)       |     |                  |     |   (Redis)        |
+------------------+     +------------------+     +------------------+
```

### Meal Planning Service Components

```
+------------------------------------------------------------------+
|                    MEAL PLANNING SERVICE                          |
+------------------------------------------------------------------+

+------------------+     +------------------+     +------------------+
|   MealPlan       |     |   MealEntry      |     |   Generate       |
|   Controller     |     |   Controller     |     |   Controller     |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         v                        v                        v
+------------------+     +------------------+     +------------------+
|   MealPlan       |     |   MealEntry      |     |   AI Meal        |
|   Service        |     |   Service        |     |   Generator      |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         v                        v                        v
+------------------+     +------------------+     +------------------+
|   MealPlan       |     |   MealEntry      |     |   Recipe         |
|   Repository     |     |   Repository     |     |   Recommender    |
+------------------+     +------------------+     +------------------+
                                  |
                                  v
                    +---------------------------+
                    |      Nutrition            |
                    |      Calculator           |
                    +---------------------------+
```

### Product Service Components

```
+------------------------------------------------------------------+
|                      PRODUCT SERVICE                              |
+------------------------------------------------------------------+

+------------------+     +------------------+     +------------------+
|   Product        |     |   Search         |     |   Price          |
|   Controller     |     |   Controller     |     |   Controller     |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         v                        v                        v
+------------------+     +------------------+     +------------------+
|   Product        |     |   Search         |     |   Price          |
|   Service        |     |   Service        |     |   Service        |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         v                        v                        v
+------------------+     +------------------+     +------------------+
|   Product        |     |   Full-Text      |     |   Price          |
|   Repository     |     |   Search Engine  |     |   History        |
|                  |     |   (PostgreSQL)   |     |   Repository     |
+------------------+     +------------------+     +------------------+
         |
         v
+------------------+
|   Product        |
|   Cache          |
|   (Redis)        |
+------------------+
```

### Scraper Worker Components

```
+------------------------------------------------------------------+
|                      SCRAPER WORKER                               |
+------------------------------------------------------------------+

+------------------+     +------------------+     +------------------+
|   Job            |     |   Scheduler      |     |   Health         |
|   Queue          |     |   (BullMQ)       |     |   Monitor        |
|   (Redis)        |     |                  |     |                  |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         +------------------------+------------------------+
                                  |
                                  v
                    +---------------------------+
                    |      Scraper              |
                    |      Orchestrator         |
                    +-------------+-------------+
                                  |
         +------------------------+------------------------+
         |                        |                        |
         v                        v                        v
+------------------+     +------------------+     +------------------+
|   Mercadona      |     |   Carrefour      |     |   Dia            |
|   Adapter        |     |   Adapter        |     |   Adapter        |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         v                        v                        v
+------------------+     +------------------+     +------------------+
|   Playwright     |     |   Playwright     |     |   Playwright     |
|   Browser Pool   |     |   Browser Pool   |     |   Browser Pool   |
+------------------+     +------------------+     +------------------+
         |                        |                        |
         +------------------------+------------------------+
                                  |
                                  v
                    +---------------------------+
                    |      Proxy                |
                    |      Manager              |
                    +---------------------------+
                                  |
                                  v
                    +---------------------------+
                    |      Data                 |
                    |      Validator            |
                    +-------------+-------------+
                                  |
                                  v
                    +---------------------------+
                    |      Product              |
                    |      Normalizer           |
                    +---------------------------+
```

### Matching Engine Components

```
+------------------------------------------------------------------+
|                      MATCHING ENGINE                              |
+------------------------------------------------------------------+

+------------------+
|   Match          |
|   Controller     |
+--------+---------+
         |
         v
+------------------+
|   Matching       |
|   Service        |
+--------+---------+
         |
         +------------------------------------------+
         |                   |                      |
         v                   v                      v
+------------------+  +------------------+  +------------------+
|   Exact          |  |   Fuzzy          |  |   Category       |
|   Matcher        |  |   Matcher        |  |   Matcher        |
|                  |  |   (pg_trgm)      |  |                  |
+------------------+  +------------------+  +------------------+
         |                   |                      |
         +-------------------+----------------------+
                             |
                             v
              +---------------------------+
              |      Match                |
              |      Ranker               |
              +-------------+-------------+
                            |
                            v
              +---------------------------+
              |      User Preference      |
              |      Adjuster             |
              +---------------------------+
                            |
                            v
              +---------------------------+
              |      Match                |
              |      Learning             |
              |      (Feedback Loop)      |
              +---------------------------+
```

---

## Browser Extension Architecture

```
+------------------------------------------------------------------+
|                    BROWSER EXTENSION (Manifest V3)                |
+------------------------------------------------------------------+

+------------------------------------------------------------------+
|                        POPUP UI (React)                           |
+------------------------------------------------------------------+
|  +----------------+  +----------------+  +----------------+       |
|  |   Login View   |  |   List View    |  |  Settings View |       |
|  +----------------+  +----------------+  +----------------+       |
+------------------------------------------------------------------+
                                |
                                v
+------------------------------------------------------------------+
|                      SERVICE WORKER                               |
+------------------------------------------------------------------+
|  +----------------+  +----------------+  +----------------+       |
|  |   Message      |  |   State        |  |   API          |       |
|  |   Handler      |  |   Manager      |  |   Client       |       |
|  +----------------+  +----------------+  +----------------+       |
|  +----------------+  +----------------+                           |
|  |   Storage      |  |   Alarm        |                           |
|  |   Manager      |  |   Scheduler    |                           |
|  +----------------+  +----------------+                           |
+------------------------------------------------------------------+
                                |
                                v
+------------------------------------------------------------------+
|                    CONTENT SCRIPTS                                |
+------------------------------------------------------------------+

+-----------------------+  +-----------------------+  +-------------+
|   Mercadona Content   |  |   Carrefour Content   |  |   Dia      |
|   Script              |  |   Script              |  |   Content   |
+-----------+-----------+  +-----------+-----------+  +-----+-------+
            |                          |                    |
            v                          v                    v
+-----------------------+  +-----------------------+  +-------------+
|  Cart Automation      |  |  Cart Automation      |  |  Cart Auto  |
|  - Add to cart        |  |  - Add to cart        |  |  - Add      |
|  - Quantity adjust    |  |  - Quantity adjust    |  |  - Qty      |
|  - Error handling     |  |  - Error handling     |  |  - Error    |
+-----------------------+  +-----------------------+  +-------------+

+-----------------------+
|   Shared Utilities    |
+-----------------------+
|  - DOM helpers        |
|  - Retry logic        |
|  - Error reporting    |
|  - Metrics collection |
+-----------------------+
```

---

## Data Flow Diagrams

### Flow 1: User Onboarding and Meal Plan Generation

```
+--------+     +----------+     +----------+     +----------+     +----------+
|  User  | --> |  Signup  | --> | Profile  | --> | Dietary  | --> | Cuisine  |
|        |     |  Form    |     |  Setup   |     | Prefs    |     | Prefs    |
+--------+     +----------+     +----------+     +----------+     +----------+
                                                                        |
                                                                        v
+----------+     +----------+     +----------+     +----------+     +----------+
| View     | <-- | Generate | <-- | AI       | <-- | Recipe   | <-- | Store    |
| Calendar |     | Meal Plan|     | Selection|     | Database |     | Profile  |
+----------+     +----------+     +----------+     +----------+     +----------+
```

### Flow 2: Meal Plan to Grocery List

```
+----------+     +----------+     +----------+     +----------+     +----------+
| Meal     | --> | Extract  | --> | Normalize| --> | Aggregate| --> | Match to |
| Plan     |     | Recipes  |     | Ingred.  |     | Quantities|    | Products |
+----------+     +----------+     +----------+     +----------+     +----------+
                                                                        |
                                                                        v
+----------+     +----------+     +----------+     +----------+     +----------+
| Final    | <-- | User     | <-- | Optimize | <-- | Price    | <-- | Product  |
| List     |     | Review   |     | List     |     | Compare  |     | Results  |
+----------+     +----------+     +----------+     +----------+     +----------+
```

### Flow 3: Automated Cart Filling

```
+----------+     +----------+     +----------+     +----------+     +----------+
| Grocery  | --> | Extension| --> | Navigate | --> | Search   | --> | Add to   |
| List     |     | Receives |     | to Store |     | Product  |     | Cart     |
+----------+     +----------+     +----------+     +----------+     +----------+
     ^                                                                   |
     |                                                                   v
+----------+     +----------+     +----------+     +----------+     +----------+
| Report   | <-- | Complete | <-- | Verify   | <-- | Adjust   | <-- | Handle   |
| Status   |     | Cart     |     | Total    |     | Quantity |     | Errors   |
+----------+     +----------+     +----------+     +----------+     +----------+
```

### Flow 4: Scraping Pipeline

```
+----------+     +----------+     +----------+     +----------+     +----------+
| Scheduler| --> | Queue    | --> | Worker   | --> | Browser  | --> | Navigate |
| Trigger  |     | Job      |     | Picks Up |     | Launch   |     | to Page  |
+----------+     +----------+     +----------+     +----------+     +----------+
                                                                        |
                                                                        v
+----------+     +----------+     +----------+     +----------+     +----------+
| Update   | <-- | Store in | <-- | Normalize| <-- | Validate | <-- | Extract  |
| Cache    |     | Database |     | Data     |     | Data     |     | Products |
+----------+     +----------+     +----------+     +----------+     +----------+
```

---

## Deployment Topology

```
+------------------------------------------------------------------+
|                     CLOUDFLARE (Edge)                             |
+------------------------------------------------------------------+
|  +------------------------+  +------------------------+           |
|  |   CDN (Static Assets)  |  |   DNS + WAF            |           |
|  +------------------------+  +------------------------+           |
+------------------------------------------------------------------+
                                |
                                v
+------------------------------------------------------------------+
|                       VERCEL                                      |
+------------------------------------------------------------------+
|  +------------------------+  +------------------------+           |
|  |   Next.js App          |  |   Edge Functions       |           |
|  |   (SSR + Static)       |  |   (API Routes)         |           |
|  +------------------------+  +------------------------+           |
+------------------------------------------------------------------+
                                |
        +-----------------------+-----------------------+
        |                       |                       |
        v                       v                       v
+----------------+      +----------------+      +----------------+
|     NEON       |      |    UPSTASH     |      |   CLOUDFLARE   |
|   (PostgreSQL) |      |    (Redis)     |      |      R2        |
|                |      |                |      |   (Blob)       |
+----------------+      +----------------+      +----------------+

+------------------------------------------------------------------+
|                       RAILWAY                                     |
+------------------------------------------------------------------+
|  +------------------------+  +------------------------+           |
|  |   Scraper Workers      |  |   Job Queue (BullMQ)   |           |
|  |   (Playwright)         |  |                        |           |
|  +------------------------+  +------------------------+           |
+------------------------------------------------------------------+
```

---

## Security Boundaries

```
+------------------------------------------------------------------+
|                    TRUST BOUNDARY: INTERNET                       |
+------------------------------------------------------------------+
     |
     v
+------------------------------------------------------------------+
|   WAF / DDoS Protection (Cloudflare)                              |
+------------------------------------------------------------------+
     |
     v
+------------------------------------------------------------------+
|                    TRUST BOUNDARY: DMZ                            |
+------------------------------------------------------------------+
     |
     +------------------------+
     |                        |
     v                        v
+----------+            +----------+
| API      |            | Static   |
| Gateway  |            | Assets   |
+----+-----+            +----------+
     |
     v (JWT Validation)
+------------------------------------------------------------------+
|                  TRUST BOUNDARY: APPLICATION                      |
+------------------------------------------------------------------+
     |
     +------------------------+------------------------+
     |                        |                        |
     v                        v                        v
+----------+            +----------+            +----------+
| Services |            | Workers  |            | Cache    |
+----+-----+            +----+-----+            +----------+
     |                       |
     v                       v (IP Allowlist)
+------------------------------------------------------------------+
|                    TRUST BOUNDARY: DATA                           |
+------------------------------------------------------------------+
     |
     v
+------------------------------------------------------------------+
| PostgreSQL (Encrypted at rest, TLS in transit)                    |
+------------------------------------------------------------------+
```

---

## Scaling Strategy

### Horizontal Scaling Points

```
                    Load Balancer
                         |
         +---------------+---------------+
         |               |               |
         v               v               v
    +--------+      +--------+      +--------+
    | API    |      | API    |      | API    |
    | Node 1 |      | Node 2 |      | Node 3 |
    +--------+      +--------+      +--------+
         |               |               |
         +---------------+---------------+
                         |
                    +----+----+
                    |  Redis  |
                    | Cluster |
                    +---------+
                         |
         +---------------+---------------+
         |               |               |
         v               v               v
    +--------+      +--------+      +--------+
    | PG     |      | PG     |      | PG     |
    | Primary|      | Read   |      | Read   |
    |        |      | Replica|      | Replica|
    +--------+      +--------+      +--------+


Scraper Workers (Independent Scaling):

         +---------------+---------------+
         |               |               |
         v               v               v
    +--------+      +--------+      +--------+
    | Worker |      | Worker |      | Worker |
    | Pool 1 |      | Pool 2 |      | Pool 3 |
    |Mercadona|     |Carrefour|     |  Dia   |
    +--------+      +--------+      +--------+
```

---

## Failure Modes and Recovery

### Component Failure Matrix

| Component | Failure Impact | Detection | Recovery |
|-----------|---------------|-----------|----------|
| API Gateway | Full outage | Health checks | Auto-restart, failover |
| Auth Service | No logins | Error rate spike | Restart, Redis fallback |
| Product Service | No search | Error rate | Cache-first, graceful degradation |
| Scraper Worker | Stale data | Job queue backup | Auto-restart, alert |
| PostgreSQL | Data unavailable | Connection errors | Failover to replica |
| Redis | Slow responses | Latency spike | Fallback to DB |
| Extension | Manual shopping | User reports | Update push |

### Circuit Breaker States

```
        +--------+
        | Closed |<---------+
        +---+----+          |
            |               |
    Failure threshold       |
    exceeded                |
            |               |
            v               |
        +-------+     Success threshold
        | Open  |     reached
        +---+---+           |
            |               |
    Timeout expires         |
            |               |
            v               |
      +----------+          |
      |Half-Open +-----------+
      +----------+
```

---

## Monitoring Dashboard Layout

```
+------------------------------------------------------------------+
|                    SYSTEM HEALTH DASHBOARD                        |
+------------------------------------------------------------------+
| +-------------------------+  +-------------------------+          |
| |   API Latency (p99)     |  |   Error Rate (%)        |          |
| |   [=====     ] 245ms    |  |   [=       ] 0.3%       |          |
| +-------------------------+  +-------------------------+          |
|                                                                   |
| +-------------------------+  +-------------------------+          |
| |   Active Users          |  |   Requests/sec          |          |
| |        1,234            |  |         456             |          |
| +-------------------------+  +-------------------------+          |
|                                                                   |
| +----------------------------------------------------------+     |
| |              Request Volume (24h)                         |     |
| |    ^                                                      |     |
| |    |    *  *                                              |     |
| |    |   *    *  *                                          |     |
| |    |  *        *  *    *                                  |     |
| |    | *            *  **  *  *                             |     |
| |    +-------------------------------------------->         |     |
| +----------------------------------------------------------+     |
|                                                                   |
| +-------------------------+  +-------------------------+          |
| |   Scraper Status        |  |   Database Connections  |          |
| |   Mercadona:    OK      |  |   [========  ] 80/100   |          |
| |   Carrefour:    OK      |  |                         |          |
| |   Dia:          WARN    |  |   Redis Memory:         |          |
| |                         |  |   [======    ] 1.2GB    |          |
| +-------------------------+  +-------------------------+          |
+------------------------------------------------------------------+
```

---

## Technology Summary

| Layer | Technology | Purpose |
|-------|------------|---------|
| Frontend | Next.js 14, React 18, TailwindCSS | Web application |
| API | Hono, Zod, Drizzle ORM | REST API |
| Database | PostgreSQL (Neon) | Primary data store |
| Cache | Redis (Upstash) | Session, cache |
| Scraping | Playwright, BullMQ | Product extraction |
| Extension | Plasmo, Manifest V3 | Browser automation |
| Deployment | Vercel, Railway, Cloudflare | Infrastructure |
| Monitoring | Axiom, Grafana | Observability |
